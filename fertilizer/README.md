# Fertilizer input
-----
This directory contains scripts to derive gridded datasets of fertilizer and
manure application rates on crops.

The scripts for fertilizer application rates combine a dataset of crop-specific
application rates for the year 2000 with another dataset providing historical
trends of fertilizer application.

## Input
By default, the following data are used for crop-specific fertilizer application
rates:

Mueller, N. D. , Gerber, J. S., Johnston, M., Ray, D. K., Ramankutty, N., and
Foley, J. A. (2012): Closing yield gaps through nutrient and water management.
Nature, 490, 254-257, https://doi.org/10.1038/nature11420

The data can be downloaded at: https://doi.org/10.5281/zenodo.5260731. Or use
`download_fertilizer_pattern.R` included in this directory.

By default, the following data are used to estimate historical trends of
fertilizer application:
Hurtt, G. C., Chini, L., Sahajpal, R., Frolking, S., Bodirsky, B. L., Calvin, K.,
Doelman, J. C., Fisk, J., Fujimori, S., Klein Goldewijk, K., Hasegawa, T.,
Havlik, P., Heinimann, A., Humpenöder, F., Jungclaus, J., Kaplan, J. O.,
Kennedy, J., Krisztin, T., Lawrence, D., Lawrence, P., Ma, L., Mertz, O.,
Pongratz, J., Popp, A., Poulter, B., Riahi, K., Shevliakova, E., Stehfest, E.,
Thornton, P., Tubiello, F. N., van Vuuren, D. P., and Zhang, X. (2020):
Harmonization of global land use change and management for the period 850–2100
(LUH2) for CMIP6, Geosci. Model Dev., 13, 5425–5464,
https://doi.org/10.5194/gmd-13-5425-2020

The data can be downloaded at: https://luh.umd.edu/data.shtml

By default, the following data are used for manure application rates:
Zhang, B., Hanqin T., Chaoqun L., Shree R. S. D., Jia Y., and Shufen P. (2017):
Global Manure Nitrogen Production and Application in Cropland during 1860–2014:
A 5 Arcmin Gridded Global Dataset for Earth System Modeling. Earth System
Science Data 9 (2): 667–78. https://doi.org/10.5194/essd-9-667-2017

The data can be downloaded at: https://doi.org/10.1594/PANGAEA.871980

By default, the following information is used to assign countries to regional
groups: https://unstats.un.org/unsd/methodology/m49/overview/

Download the Excel version and convert into CSV. Set as `country_group_file` in
`../fertilizer_setup.R`.

The scripts in this directory require data generated by the scripts in `../gadm`
and `../landuse` so make sure to run these first.

## Software requirements
- `R`
- R packages `abind`, `ncdf4`, `raster`, `stringdist`, `stringi`, `tools`,
  `udunits2`

## Files included in this directory
- cft_input_timeseries.R: Script generates fertilizer and manure inputs in final
  LPJmL format
- cft_input_timeseries_SLURM.sh: Example batch script to run
  cft_input_timeseries.R as a job on the PIK cluster
- combine_fertilizer_pattern_trend_national.R: Script combines spatial
  fertilizer patterns with fertilizer trends at the national scale
- combine_fertilizer_pattern_trend_national_SLURM.sh: Example batch script to
  run combine_fertilizer_pattern_trend_national.R as a job on the PIK cluster
- crop_types_fert_Monfreda_FAOSTAT_LUH2.csv: Mappings between crop naming
  schemas used in the different source datasets
- download_fertilizer_pattern.R: Script downloads spatial fertilizer patterns
  from the internet
- fertilizer_setup.R: This file contains most settings used by all the other R
  scripts in this directory.
- gapfill_fertilizer_pattern.R: Script conducts spatial gap-filling of
  fertilizer pattern data
- gapfill_fertilizer_pattern_SLURM.sh: Example batch script to run
  gapfill_fertilizer_pattern.R as a job on the PIK cluster
- gapfill_fertilizer_trend.R: Script conducts spatial gap-filling of fertilizer
  trend data
- gapfill_fertilizer_trend_SLURM.sh: Example batch script to run
  gapfill_fertilizer_trend.R as a job on the PIK cluster
- preprocess_manure.R: Script converts raw source data for manure from Zhang et
  al. into NetCDF file for further processing
- process_manure.R: Script prepares manure data from Zhang et al. for conversion
  into LPJmL input format
- README.md: This file

## How to use
- See README files in subdirectories for instructions on how to download source
  datasets.
- Set up `fertilizer_setup.R`. Most settings can be left as-is if working with
  the default datasets. However, paths to files normally found in `../gadm` and
  `../landuse` need to be added.
- Generate a time series of gridded manure application rates:
  1. Run `preprocess_manure.R`
  2. Run `process_manure.R`
- Generate a gridded time series of crop-specific fertilizer application rates.
  Note: The toolbox currently only supports combining fertilizer patterns with
  national trends. An option to combine patterns with subnational trends may be
  added at a later stage.
  3. Run `gapfill_fertilizer_pattern.R`
  4. Run `gapfill_fertilizer_trend.R`
  5. Run `combine_fertilizer_pattern_trend_national.R`
- Convert time series of fertilizer and manure application rates created by
  steps 1-5 into input files for LPJmL. This includes aggregation from
  individual crops to crop-functional types and, if necessary, spatial
  aggregation.
  6. Run `cft_input_timeseries.R`

The suggested procedure is to run steps 1-5 at the finest spatial resolution
possible and aggregate only spatially only in step 6, if requested LPJmL input
files are at a coarser resolution. Note that the output resolution cannot be
finer than any of the gridded source datasets (fertilizer patterns, manure, and
weighting data sets cropland, grazing land, harvested areas).
