# River routing input
-----
Scripts in this directory create input files related to river routing.

## Input
  1) a grid file, as generated by scripts in `../gadm`
  2) a drainage direction map in the correct spatial resolution
  3) a land fraction file (optionally), as generated by scripts in `../gadm`

## Files included in this directory
  - create_river_routing_input.sh: Shell script to convert drainage direction
    map into LPJmL river routing input format.
  - neighbour_irrigation.R: Script to derive neighbour irrigation cells.
  - neighbour_irrigation_SLURM.sh: Example batch script to submit
    neighbour_irrigation.R as a job on the PIK high performance cluster.
  - README.md: This file.
  - river_routing.R: Script to derive lists of upstream cells, downstream cells,
    and upstream areas based on river routing input file.
  - r_modules.sh: Example shell script to load necessary modules to run R
    scripts on PIK high-performance cluster.
  
## Software requirements
- `drainage` utility from LPJmL model repository
- `R`
- R packages `foreach`, `geosphere`, `raster`, to use MPI backend for
  parallelization: `doMPI`, `Rmpi`; or use `doParallel`, `parallel` to run on
  multiple CPUs of a local machine.
  
## Setup for create_river_routing_input.sh
  - `DRAINAGEBIN`: Set path to drainage utility which is included in LPJmL model
    repository.
  - `LPJGRID`: Set path to LPJmL grid input file.
  - `DDMASCII`: Set path to drainage direction map in ASCII grid format; this
    must be in the same resolution as the grid file.
  - `RIVERROUTINGFILE`: Set river routing filename to be created.

## Setup for river_routing.R
  - `drainagedir`: Directory where outputs of the script will be saved.
  - `gridname`: Set path to LPJmL grid input file.
  - `drainname`: Set path to river routing input file (e.g. one created by
    `create_river_routing_input.sh`).
  - `landfracname`: Set path to optional LPJmL input file containing land
    fraction in each cell, must match grid file if supplied.
  - `version_string`: Optional version string added to filenames of RData files
    created by this script.

## Setup for neighbour_irrigation.R
  - `drainagedir`: Directory where outputs of the script will be saved.
  - `gridname`: Set path to LPJmL grid input file.
  - `drainname`: Set path to river routing input file (e.g. one created by
    `create_river_routing_input.sh`).
  - `cluster`: Whether to try parallelization on a multi-CPU cluster.
  - `version_string`: Optional version string added to filenames of RData files
    created by this script.
  - `search_area`: Where to look for neighbour cell, either directly "adjacent"
    cells or cells within search "region".
  - `search_radius`: Maximum distance of neighbour cells if `search_area` is
    "region".
  - `exclude_upstream`: Whether to exclude all upstream cells as potential
    neighbour cell.
  - `exclude_downstream`: Whether to exclude all downstream cells as potential
    neighbour cell.
  - `idw_power_par`: Power parameter used for inverse distance weighting of
    potential neighbour cells (set to 0 for no weighting).
  - `neighbour_format`: File format for neighbour irrigation input file, "BIN"
    for LPJmL native input format, or "CSV".
  - `bintype`: Header version used for "BIN" format.
  - `neighbour_headername`: Header name used for "BIN" format. Must match header
    name defined in LPJmL source code.

## How to use
Run in order:
1) create_river_routing_input.sh
2) river_routing.R
3) neighbour_irrigation.R

Drainage direction maps are provided by, for example:
- STN-30: https://wsag.unh.edu/Stn-30/stn-30.html (global, 0.5°)
- DDM30: https://www.uni-frankfurt.de/45218101/DDM30 (global, 0.5°)
- HydroSHEDS: https://hydrosheds.org/ (continental scale, 3 arc-second, 15
  arc-second, 30 arc-second, 5 arc-minute, 6 arc-minute)
- Upscaled versions of HydroSHEDS (not using "official" HydroSHEDS upscaling
  methods, see Wu et al. 2012 below):
  http://files.ntsg.umt.edu/data/DRT/upscaled_global_hydrography/by_HydroSHEDS_Hydro1k/
- MERIT Hydro: http://hydro.iis.u-tokyo.ac.jp/~yamadai/MERIT_Hydro/ (global
  scale, 3 arc-second)
- Upscaled versions of MERIT Hydro (see Eilander et al. 2021 below):
  https://doi.org/10.5281/zenodo.5166932

The toolbox does *not* provide functionality to rescale a drainage direction map
to a different spatial resolution. The HydroSHEDS technical documentation
provides some guidance on upscaling a drainage direction map:
https://hydrosheds.org/page/development

The following publications also describe upscaling methods:
- Eilander et al. (2021): "A Hydrography Upscaling Method for Scale-Invariant
  Parametrization of Distributed Hydrological Models", Hydrology and Earth
  System Sciences 25 (9): 5287–5313. https://doi.org/10.5194/hess-25-5287-2021.
- Wu et al. (2012): "A New Global River Network Database for Macroscale
  Hydrologic Modeling", Water Resources Research 48 (9): 2012WR012313.
  https://doi.org/10.1029/2012WR012313.
