# Reservoir input
-----
This directory contains scripts to derive a dam/reservoir input for LPJmL.

## Input
You will need a copy of the Global Reservoir and Dam (GRanD) database which can
be downloaded from: https://globaldamwatch.org/grand/

You will also need a grid file, generated by scripts in `../gadm`, as well as
data generated by scripts in `../river_routing`.

## Software requirements
- `R`
- R packages `foreign`, `geosphere`, `lwgeom` (depending on version of `sf`),
  `maps`, `raster`, `RColorBrewer`, `sf`, `udunits2`

## Files included in this directory
  - process_reservoirs.R: script to derive dam/reservoir input for LPJmL
  - README.md: this file
  - r_modules.sh: bash script that loads all required modules to run R script on
    the PIK high performance cluster

## Set up in process_reservoirs.R
  - `grand_dir`: working directory where files will be created
  - `grand_name`: path to attribute table (*.dbf file) of GRanD
  - `gridname`: path to grid file in LPJmL input format
  - `upstreamarea_RData`: path to RData file containing upstream areas matching
    the grid file (this RData file is created by scripts in directory
    `../river_routing`)
  - `version_string`: optional version string added to files created by this
    script
  - `search_rad`: maximum search radius (in degree) in which to assign each dam
    to a grid cell
  - `max_dist`: optional maximum distance (in metres) between GRanD coordinates
    and assigned grid cell (applied on top of search radius)
  - `deviation_penalty`, `distance_penalty`: power parameters used in weighting
    function (more than one value can be supplied per parameter)
  - `pos_penalty`, `neg_penalty`: allows to assign different deviation penalty
    based on whether catchment area is overshot or undershot (more than one
    value can be supplied per parameter)
  - `fix_area`: whether to estimate reservoir area for reservoirs with missing
    area in GRanD
  - `minimum_startyear`: start year to use for dams/reservoirs with missing year
    information in GRanD
  - `last_includeyear`: cut-off year, only include dams/reservoirs built before
    this year
  - `grand_area_unit`, `grand_capacity_unit`: units used in GRanD database
  - `lpjml_area_unit`, `lpjml_capacity_unit`: units used in LPJmL input (used
    for automatic unit conversion); these must match units defined in the LPJmL
    source code
  - `timeline_action`: define filter actions based on "timeline" attribute in
    GRanD database
  - `bintype`: Header version used for LPJmL input format
  - `headername`: Header name used for LPJmL input format. Must match header
    name defined in LPJmL source code
  - `manual_assignment`: optional table to prescribe grid cell assignments
    manually if automatic assignment does not give satisfactory results for
    certain GRanD dams/reservoir

The script runs automatically for all parameter combinations of
`deviation_penalty`, `distance_penalty`, `pos_penalty` and `neg_penalty`. 

## Files created by process_reservoirs.R
  - reservoir_`[[version_string_]][resolution_string]`_par`[index of parameter combination]`.bin:
    input file in LPJmL format
  - reservoir_`[[version_string_]][resolution_string]`_par`[index of parameter combination]`_settings.csv:
    CSV table listing parameter values used to create matching input file
  - reservoir_diagnostics_`[[version_string_]][resolution_string]_[number of parameter combinations]`_settings.pdf:
    maps showing GRanD dam and reservoir locations and assigned grid cells for
    all parameter combinations
  - reservoir_diagnostics_`[[version_string_]][resolution_string]_[number of parameter combinations]`_settings.Rdata:
    some diagnostics which can be used to analyse grid cell assignment, such as
    distance between GRanD coordinates and assigned grid cell
